name: Universal Release

on:
  push:
    tags:
      - 'v*'
    branches:
      - 'release/v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: false
        type: string

permissions:
  contents: write

env:
  NODE_VERSION: '20'

jobs:
  # ===== DETECT PROJECT TYPE =====
  detect:
    name: Detect Project Type
    runs-on: ubuntu-latest
    outputs:
      project_type: ${{ steps.detect.outputs.type }}
      has_electron: ${{ steps.detect.outputs.has_electron }}
      has_docker: ${{ steps.detect.outputs.has_docker }}
      package_manager: ${{ steps.detect.outputs.package_manager }}
      version: ${{ steps.version.outputs.VERSION }}
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Extract version
        id: version
        shell: bash
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          elif [[ "$GITHUB_REF" == refs/heads/release/* ]]; then
            VERSION="${GITHUB_REF#refs/heads/release/}"
          else
            VERSION="unknown"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Version: $VERSION"

      - name: Detect project type
        id: detect
        shell: bash
        run: |
          # Check package manager
          if [ -f "pnpm-lock.yaml" ]; then
            echo "package_manager=pnpm" >> $GITHUB_OUTPUT
          elif [ -f "yarn.lock" ]; then
            echo "package_manager=yarn" >> $GITHUB_OUTPUT
          else
            echo "package_manager=npm" >> $GITHUB_OUTPUT
          fi
          
          # Check for Electron
          if [ -f "package.json" ] && grep -q '"electron"' package.json; then
            echo "has_electron=true" >> $GITHUB_OUTPUT
            echo "type=electron" >> $GITHUB_OUTPUT
            echo "ðŸ–¥ï¸ Detected: Electron Desktop App"
          # Check for Docker
          elif [ -f "Dockerfile" ]; then
            echo "has_docker=true" >> $GITHUB_OUTPUT
            echo "type=docker" >> $GITHUB_OUTPUT
            echo "ðŸ³ Detected: Docker Application"
          # Check for Library (has main/module field, no build output)
          elif [ -f "package.json" ] && grep -qE '"main"|"module"|"exports"' package.json && ! grep -q '"build"' package.json; then
            echo "type=library" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Detected: NPM Library"
          # Check for Web App (has vite/next/webpack)
          elif [ -f "package.json" ] && grep -qE '"vite"|"next"|"webpack"|"react-scripts"' package.json; then
            echo "type=web" >> $GITHUB_OUTPUT
            echo "ðŸŒ Detected: Web Application"
          else
            echo "type=generic" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ Detected: Generic Node.js Project"
          fi

  # ===== BUILD ELECTRON DESKTOP APP =====
  build-electron:
    name: Build Electron (${{ matrix.os }})
    needs: detect
    if: needs.detect.outputs.has_electron == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: win
          - os: macos-latest
            platform: mac
          - os: ubuntu-latest
            platform: linux

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: ${{ needs.detect.outputs.package_manager }}

      - name: Install dependencies
        run: |
          if [ "${{ needs.detect.outputs.package_manager }}" == "pnpm" ]; then
            npm install -g pnpm && pnpm install
          elif [ "${{ needs.detect.outputs.package_manager }}" == "yarn" ]; then
            yarn install --frozen-lockfile
          else
            npm ci || npm install
          fi
        shell: bash

      - name: Build application
        run: |
          if [ "${{ needs.detect.outputs.package_manager }}" == "pnpm" ]; then
            pnpm run build
          elif [ "${{ needs.detect.outputs.package_manager }}" == "yarn" ]; then
            yarn build
          else
            npm run build
          fi
        shell: bash

      - name: Package Electron for ${{ matrix.platform }}
        run: |
          npx electron-builder --${{ matrix.platform }} --publish never
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: electron-${{ matrix.platform }}
          path: |
            release/**/*.exe
            release/**/*.msi
            release/**/*.zip
            release/**/*.dmg
            release/**/*.AppImage
            release/**/*.deb
            release/**/*.rpm
            release/**/*.yml
            release/**/*.blockmap
          if-no-files-found: ignore

  # ===== BUILD WEB APP =====
  build-web:
    name: Build Web App
    needs: detect
    if: needs.detect.outputs.project_type == 'web'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: ${{ needs.detect.outputs.package_manager }}

      - name: Install and build
        run: |
          npm ci || npm install
          npm run build
        shell: bash

      - name: Upload web artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: |
            dist/
            build/
            out/
            .next/
          if-no-files-found: ignore

  # ===== BUILD DOCKER =====
  build-docker:
    name: Build Docker Image
    needs: detect
    if: needs.detect.outputs.has_docker == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t app:${{ needs.detect.outputs.version }} .
          docker save app:${{ needs.detect.outputs.version }} > docker-image.tar

      - name: Upload Docker image
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: docker-image.tar

  # ===== CREATE RELEASE =====
  release:
    name: Create GitHub Release
    needs: [detect, build-electron, build-web, build-docker]
    if: always() && needs.detect.result == 'success'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: List artifacts
        run: |
          echo "ðŸ“¦ Downloaded artifacts:"
          find artifacts -type f 2>/dev/null || echo "No artifacts found"

      - name: Prepare release files
        run: |
          mkdir -p release-files
          find artifacts -type f \( \
            -name "*.exe" -o -name "*.msi" -o -name "*.zip" -o \
            -name "*.dmg" -o -name "*.AppImage" -o -name "*.deb" -o \
            -name "*.rpm" -o -name "*.yml" -o -name "*.blockmap" -o \
            -name "*.tar" \
          \) -exec cp {} release-files/ \; 2>/dev/null || true
          ls -la release-files/ || echo "No files to release"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.detect.outputs.version }}
          name: Release ${{ needs.detect.outputs.version }}
          files: release-files/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(needs.detect.outputs.version, '-') }}
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

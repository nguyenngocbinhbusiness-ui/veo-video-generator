name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # SECURITY SCANNING
  # ============================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'
      
      - name: Find and audit package.json
        run: |
          if [ -f "project/package.json" ]; then
            cd project && npm ci && npm audit --audit-level=high || true
          elif [ -f "package.json" ]; then
            npm ci && npm audit --audit-level=high || true
          fi
      
      - name: Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # ============================================
  # LINT & TYPE CHECK
  # ============================================
  lint-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'
      
      - name: Detect project structure and install
        run: |
          if [ -f "project/package.json" ]; then
            cd project && npm ci
          elif [ -f "package.json" ]; then
            npm ci
          fi
      
      - name: Run ESLint
        run: |
          if [ -f "project/package.json" ]; then
            cd project && npm run lint --if-present
          elif [ -f "package.json" ]; then
            npm run lint --if-present
          fi
      
      - name: Type check
        run: |
          if [ -f "project/tsconfig.json" ]; then
            cd project && npx tsc --noEmit
          elif [ -f "tsconfig.json" ]; then
            npx tsc --noEmit
          fi

  # ============================================
  # UNIT & INTEGRATION TESTS
  # ============================================
  unit-tests:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'
      
      - name: Install and run tests
        run: |
          if [ -f "project/package.json" ]; then
            cd project
            npm ci
            npm run test:unit --if-present -- --reporter=verbose
            npm run test:integration --if-present -- --reporter=verbose
          elif [ -f "package.json" ]; then
            npm ci
            npm run test:unit --if-present -- --reporter=verbose
            npm run test:integration --if-present -- --reporter=verbose
          fi

  # ============================================
  # E2E TESTS
  # ============================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'
      
      - name: Install dependencies
        run: |
          if [ -f "project/package.json" ]; then
            cd project && npm ci
          elif [ -f "package.json" ]; then
            npm ci
          fi
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      
      - name: Run E2E tests
        run: |
          if [ -f "project/package.json" ]; then
            cd project && npm run test:e2e --if-present
          elif [ -f "package.json" ]; then
            npm run test:e2e --if-present
          fi
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: '**/playwright-report/'
          retention-days: 7
          if-no-files-found: ignore

  # ============================================
  # DOCUMENTATION GENERATION
  # ============================================
  docs:
    name: Generate Documentation
    runs-on: ubuntu-latest
    needs: [lint-typecheck]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'
      
      - name: Install and generate docs
        run: |
          if [ -f "project/package.json" ]; then
            cd project && npm ci
            npx typedoc --out docs/api src/ --skipErrorChecking || echo "TypeDoc not configured"
          elif [ -f "package.json" ]; then
            npm ci
            npx typedoc --out docs/api src/ --skipErrorChecking || echo "TypeDoc not configured"
          fi
      
      - name: Upload documentation
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: '**/docs/api/'
          retention-days: 30
          if-no-files-found: ignore

  # ============================================
  # BUILD VERIFICATION
  # ============================================
  build-check:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [lint-typecheck, unit-tests, security]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'
      
      - name: Install and build
        run: |
          if [ -f "project/package.json" ]; then
            cd project && npm ci && npm run build --if-present
          elif [ -f "package.json" ]; then
            npm ci && npm run build --if-present
          fi
